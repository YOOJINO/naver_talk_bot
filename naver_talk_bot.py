# -*- coding: utf-8 -*-
from flask import Flask, request, jsonify
import threading
import time

app = Flask(__name__)

########################################################
# 💬 자동 장문 답변(너가 원하는 안내문 그대로)
########################################################
AUTO_REPLY = """
1. 『배송안내』

해당 상품은 해외직구 상품이며, 배송일은 영업일 기준 10~14일 정도 소요됩니다.

ㅡ ㅡ ㅡ ㅡ ㅡ ㅡ ㅡ ㅡ ㅡ ㅡ ㅡ ㅡ

2. 『배송조회』

- 세관 통관중
목록통관접수일 기준 영업일 4~5일 이내 배송완료 됩니다.

📌 조회 방법
1) https://unipass.customs.go.kr
2) [화물진행정보] → M B/L 또는 H B/L 선택
3) 운송장번호 입력 → 검색

- 세관 통관 후
📦 CJ대한통운 조회 : https://www.cjlogistics.com/

ㅡ ㅡ ㅡ ㅡ ㅡ ㅡ ㅡ ㅡ ㅡ ㅡ ㅡ ㅡ

3. 『상품문의』

📱 연락처 : 010-5196-6466

👇 문자 발송 시 아래 내용 남겨주세요
1) 상품 링크
2) 문의 내용
3) 구매 수량

ㅡ ㅡ ㅡ ㅡ ㅡ ㅡ ㅡ ㅡ ㅡ ㅡ ㅡ ㅡ

그 외 배송/반품/교환/기타 문의는
📞 고객센터 : 010-5196-6466 으로 연락 주시면 감사하겠습니다.

오늘도 행복한 하루 보내세요 😊
감사합니다.
"""

########################################################
# 🏁 상담 종료 명령어 리스트
########################################################
FINISH_KEYWORDS = ["완료", "상담끝", "고마워", "bye", "끝", "감사", "thank"]

########################################################
# 🛑 상담완료 응답 포맷
########################################################
def complete_response():
    return jsonify({
        "event": "send",
        "textContent": {"text": "상담을 종료합니다 😊"},
        "complete": "true"
    })

########################################################
# ⏱ 5초 후 자동 상담완료
########################################################
def auto_finish():
    time.sleep(5)
    return complete_response()

########################################################
# 📌 Webhook
########################################################
@app.route("/", methods=["POST"])
def webhook():
    data = request.get_json()

    # 유저가 입력한 텍스트 추출
    text = data.get("textContent", {}).get("text", "")

    # 🔸 사용자가 “완료/상담끝/고마워…” 입력하면 즉시 종료
    if text in FINISH_KEYWORDS:
        return complete_response()

    # 🔸 자동 답장 보내기
    response = {
        "event": "send",
        "textContent": {"text": AUTO_REPLY}
    }

    # 🔸 답장 후 5초 뒤 자동 상담완료 스레드 실행
    threading.Thread(target=auto_finish).start()

    return jsonify(response)

########################################################
# 🚀 서버 실행
########################################################
if __name__ == "__main__":
    app.run(host="0.0.0.0", port=8080, debug=False)
